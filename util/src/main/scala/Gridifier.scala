// Copyright 2011 Foursquare Labs Inc. All Rights Reserved.

package com.foursquare.geo.shapes

import com.vividsolutions.jts.util.GeometricShapeFactory
import com.vividsolutions.jts.geom.{Coordinate, Geometry}
import java.io.File
import org.geotools.data._
import org.geotools.data.shapefile.ShapefileDataStoreFactory
import org.geotools.data.simple.SimpleFeatureSource
import org.geotools.feature.{AttributeTypeBuilder, NameImpl}
import org.geotools.feature.simple.SimpleFeatureTypeImpl
import org.opengis.feature.`type`.{AttributeDescriptor, AttributeType}
import scalaj.collection.Imports._
import com.vividsolutions.jts.geom.Geometry
import java.io.File
import java.nio.charset.Charset
import org.geotools.data.shapefile.ShapefileDataStore
import org.opengis.feature.simple.SimpleFeature
import scalaj.collection.Imports._
import org.geotools.data.DataUtilities;
import org.geotools.data.DefaultTransaction;
import org.geotools.data.Transaction;
import org.geotools.data.shapefile.ShapefileDataStore;
import org.geotools.data.shapefile.ShapefileDataStoreFactory;
import org.geotools.data.collection.ListFeatureCollection;
import org.geotools.data.simple.SimpleFeatureSource;
import org.geotools.data.simple.SimpleFeatureStore;
import org.geotools.feature.FeatureCollections;
import org.geotools.feature.simple.SimpleFeatureBuilder;
import org.geotools.feature.simple.SimpleFeatureTypeBuilder;
import org.geotools.geometry.jts.JTSFactoryFinder;
import org.geotools.referencing.crs.DefaultGeographicCRS;
import org.opengis.feature.simple.SimpleFeature;
import org.opengis.feature.simple.SimpleFeatureType;

import com.vividsolutions.jts.geom.Coordinate;
import com.vividsolutions.jts.geom.GeometryFactory;
import com.vividsolutions.jts.geom.Point;

// lat, lng
// y, x
// -90->90, -180->180

class SimpleGeometryWriter() {
  val TYPE = DataUtilities.createType("Location",
    "location:MultiPolygon:srid=4326," + // <- the geometry attribute: Point type
    "name:String" // <- a String attribute
  );
  val featureBuilder = new SimpleFeatureBuilder(TYPE)
  val collection = new ListFeatureCollection(TYPE)

  def add(g: Geometry, s: String) {
    featureBuilder.add(g);
    featureBuilder.add(s);
    val feature = featureBuilder.buildFeature(null);
    collection.add(feature);
  }

  def write(filename: String) {
    val file = new File(filename)
    val dataStoreFactory = new ShapefileDataStoreFactory();

    val params = Map(
      ("url", file.toURI().toURL())
    )
    val newDataStore = dataStoreFactory.createNewDataStore(params.asJava).asInstanceOf[ShapefileDataStore]
    newDataStore.createSchema(TYPE);

    newDataStore.forceSchemaCRS(DefaultGeographicCRS.WGS84);

    val transaction = new DefaultTransaction("create");
    val typeName = newDataStore.getTypeNames()(0)
    val featureStore = newDataStore.getFeatureSource(typeName).asInstanceOf[SimpleFeatureStore]
    featureStore.addFeatures(collection);
    transaction.commit();
  }
}

import com.vividsolutions.jts.io.WKTReader
object GridifierTest {
  def test(numXCells: Int, numYCells: Int) {
    val wkt = "MULTIPOLYGON (((-74.04626499999999 40.691158, -74.04607 40.691185, -74.04585999999999 40.691102, -74.04529699999999 40.690899, -74.044848 40.690728, -74.04453099999999 40.690584, -74.044279 40.690463, -74.044048 40.690309, -74.043931 40.690225, -74.043917 40.690214999999995, -74.043773 40.690083, -74.04366399999999 40.689935, -74.043556 40.689724999999996, -74.043521 40.689588, -74.04351299999999 40.689274, -74.043556 40.689147, -74.04358599999999 40.688981999999996, -74.043658 40.688860999999996, -74.043803 40.688756999999995, -74.043977 40.688658, -74.044208 40.688607999999995, -74.04439599999999 40.688542, -74.044569 40.688581, -74.044794 40.688658, -74.045074 40.688735, -74.04536999999999 40.688877999999995, -74.045616 40.689022, -74.045883 40.689143, -74.046144 40.68927, -74.04647 40.68949, -74.04657 40.689639, -74.046751 40.689859, -74.046995 40.690173, -74.047285 40.690503, -74.047133 40.690542, -74.04710399999999 40.690563999999995, -74.047119 40.690646, -74.047184 40.690684999999995, -74.047212 40.690723, -74.047234 40.69085, -74.047249 40.690999, -74.047169 40.691114, -74.047097 40.691142, -74.04689499999999 40.691125, -74.046568 40.691147, -74.04626499999999 40.691158)), ((-74.039403 40.700468, -74.03833 40.699248999999995, -74.0382 40.699217999999995, -74.038141 40.699149999999996, -74.03817599999999 40.699087, -74.03829499999999 40.699031999999995, -74.03844099999999 40.698972, -74.038583 40.698916, -74.038815 40.698879999999996, -74.03897599999999 40.698865, -74.039204 40.698868, -74.039324 40.698909, -74.039391 40.698977, -74.03943199999999 40.699081, -74.03949 40.699152999999995, -74.039565 40.699177, -74.039631 40.699134, -74.03966299999999 40.699079999999995, -74.039732 40.699025999999996, -74.039817 40.699009, -74.040155 40.699276, -74.039665 40.699276, -74.039734 40.699373, -74.03987599999999 40.699447, -74.040003 40.699546999999995, -74.040106 40.699618, -74.04015 40.699737, -74.04017 40.699836999999995, -74.04017499999999 40.699908, -74.04010099999999 40.700033999999995, -74.040121 40.700101, -74.04020899999999 40.700142, -74.040292 40.700171, -74.040302 40.700275, -74.040346 40.700387, -74.04036099999999 40.700475999999995, -74.040312 40.700539, -74.040177 40.700604999999996, -74.040064 40.700635, -74.039932 40.700652999999996, -74.039795 40.700627, -74.039726 40.70059, -74.039608 40.700538, -74.039491 40.700509, -74.039403 40.700468)), ((-73.729438 40.722536999999996, -73.72963299999999 40.722453, -73.73032599999999 40.722156999999996, -73.72969499999999 40.720571, -73.729661 40.720483, -73.729433 40.719865, -73.729255 40.719381, -73.729176 40.719167, -73.72894 40.718306, -73.72857599999999 40.71698, -73.728522 40.716784, -73.72841799999999 40.716391, -73.728313 40.715998, -73.728188 40.715523999999995, -73.728064 40.715050999999995, -73.727698 40.713662, -73.72733199999999 40.712272, -73.727317 40.712216, -73.727094 40.711293, -73.727086 40.711259, -73.726979 40.710812, -73.726905 40.710017, -73.726818 40.709707, -73.726462 40.708379, -73.726339 40.707761, -73.72599 40.706252, -73.72596399999999 40.70614, -73.725938 40.706029, -73.725906 40.70482, -73.72587399999999 40.703610999999995, -73.725867 40.703205, -73.72584599999999 40.703015, -73.72584499999999 40.702940999999996, -73.725843 40.702841, -73.725867 40.702740999999996, -73.72586 40.702604, -73.725799 40.702248, -73.72575499999999 40.701992, -73.72572699999999 40.701895, -73.725645 40.701651, -73.72556 40.701395999999995, -73.72555299999999 40.701288999999996, -73.72554199999999 40.701125, -73.725488 40.700618999999996, -73.725465 40.700403, -73.72537 40.699712999999996, -73.725368 40.699684999999995, -73.72537299999999 40.699636999999996, -73.72546299999999 40.698937, -73.725509 40.698575, -73.725555 40.698212999999996, -73.725607 40.697798999999996, -73.72563199999999 40.697700000000005, -73.72569 40.697466999999996, -73.725748 40.697219, -73.726405 40.696863, -73.726461 40.696669, -73.726287 40.691207, -73.72628 40.691069999999996, -73.726274 40.690934, -73.726266 40.690771999999996, -73.726258 40.690611, -73.726259 40.690269, -73.726372 40.689713999999995, -73.726231 40.689659999999996, -73.726385 40.689571, -73.726377 40.689442, -73.72618899999999 40.688649, -73.725922 40.688005, -73.725926 40.687762, -73.725938 40.686892, -73.725956 40.685682, -73.725843 40.685248, -73.72580099999999 40.684732, -73.725798 40.684354, -73.725686 40.684112, -73.725726 40.683907999999995, -73.725792 40.683574, -73.725861 40.683223, -73.72590699999999 40.682657, -73.725824 40.681636, -73.725796 40.68136, -73.725754 40.680946, -73.725714 40.680529, -73.725687 40.68025, -73.725695 40.680195999999995, -73.72588 40.678954, -73.72591899999999 40.678692999999996, -73.72593599999999 40.67858, -73.726011 40.678078, -73.726255 40.677349, -73.726373 40.676995999999995, -73.726456 40.676747999999996, -73.72654299999999 40.676487, -73.726713 40.676089999999995, -73.726851 40.675768999999995, -73.726945 40.675551999999996, -73.727141 40.675095999999996, -73.727301 40.674738999999995, -73.727441 40.674428999999996, -73.727541 40.674206999999996, -73.727577 40.674025, -73.727609 40.673863, -73.727767 40.673066, -73.727918 40.672340999999996, -73.72805799999999 40.671625999999996, -73.728062 40.671605, -73.728077 40.671562, -73.727974 40.670992999999996, -73.727941 40.670809, -73.727926 40.670097, -73.727992 40.669427, -73.728128 40.668707999999995, -73.728264 40.668073, -73.728222 40.667314, -73.728264 40.666606, -73.728383 40.666427, -73.72830499999999 40.665917, -73.728188 40.665307, -73.72814 40.665002, -73.727732 40.664549, -73.727577 40.663855, -73.72778 40.663109, -73.72838899999999 40.663033999999996, -73.728313 40.662349, -73.72798999999999 40.661719999999995, -73.72764699999999 40.661058, -73.727363 40.660326, -73.72711199999999 40.659746, -73.726444 40.659161999999995, -73.72621099999999 40.658479, -73.725927 40.657731, -73.725882 40.657537, -73.725759 40.656998, -73.725552 40.655041, -73.725331 40.654309999999995, -73.725055 40.653509, -73.725105 40.653045, -73.725295 40.653044, -73.725687 40.652654999999996, -73.725946 40.652243, -73.726047 40.652083, -73.726179 40.651982, -73.726587 40.651671, -73.72659 40.651663, -73.726647 40.651486999999996, -73.728548 40.651081, -73.728689 40.651050999999995, -73.728983 40.650966, -73.729642 40.650774, -73.729721 40.650751, -73.729978 40.650676, -73.73108599999999 40.650354, -73.73208199999999 40.650064, -73.7322 40.650048, -73.734419 40.649746, -73.734785 40.649696, -73.735834 40.649302, -73.736556 40.649031, -73.737374 40.648686999999995, -73.73742399999999 40.648666, -73.73775599999999 40.648526, -73.73881899999999 40.648193, -73.73899 40.64814, -73.73907799999999 40.648112999999995, -73.739378 40.648204, -73.739859 40.648227, -73.74087999999999 40.647836999999996, -73.740966 40.647861, -73.74145 40.647997, -73.741961 40.647973, -73.74172 40.647217999999995, -73.74170000000001 40.647166, -73.741599 40.646898, -73.74153799999999 40.646235, -73.741558 40.646145, -73.74183599999999 40.644884999999995, -73.74192 40.644082, -73.741937 40.643923, -73.742013 40.643191, -73.74202799999999 40.643076, -73.742072 40.642734, -73.74204499999999 40.642661, -73.74201599999999 40.642582999999995, -73.742012 40.642573999999996, -73.741895 40.642092999999996, -73.741875 40.642011, -73.74189299999999 40.641262, -73.741428 40.640502, -73.742283 40.640121, -73.741534 40.63923, -73.741263 40.638905, -73.741224 40.638828, -73.741126 40.638656, -73.74103199999999 40.638476, -73.740662 40.637833, -73.740284 40.637175, -73.739846 40.635812, -73.740115 40.635511, -73.740529 40.63529, -73.74094199999999 40.635069, -73.742149 40.63484, -73.74253999999999 40.635000000000005, -73.74251 40.635435, -73.741787 40.636196, -73.741542 40.63666, -73.741282 40.637152, -73.74131299999999 40.637471999999995, -73.741944 40.637906, -73.742485 40.638042999999996, -73.743116 40.638042, -73.743776 40.637836, -73.744016 40.637698, -73.744057 40.637583, -73.74529 40.634128, -73.746702 40.633387, -73.766487 40.625687, -73.767023 40.625484, -73.766954 40.624837, -73.76690599999999 40.624542, -73.766954 40.623172, -73.766814 40.621082, -73.766755 40.620435, -73.766409 40.617998, -73.766063 40.615559999999995, -73.766016 40.615244, -73.765969 40.614927, -73.765742 40.614515, -73.764349 40.614315999999995, -73.763476 40.613706, -73.763454 40.61369, -73.762084 40.612732, -73.760021 40.611349, -73.759631 40.611297, -73.759334 40.611258, -73.75754599999999 40.611036999999996, -73.757235 40.610993, -73.755197 40.610594, -73.755186 40.610302, -73.755173 40.609984, -73.753458 40.61052, -73.750652 40.611453, -73.75008799999999 40.611641, -73.74911999999999 40.612035999999996, -73.748299 40.612218, -73.747993 40.61231, -73.747614 40.611998, -73.747451 40.612072, -73.747216 40.612179, -73.74694199999999 40.611775, -73.746855 40.611574, -73.745761 40.611992, -73.745663 40.611812, -73.745633 40.611756, -73.745368 40.611204, -73.744567 40.610116999999995, -73.74387 40.608892999999995, -73.74354699999999 40.608422999999995, -73.74338 40.608179, -73.743206 40.608013, -73.74307 40.607886, -73.743355 40.607499, -73.743147 40.60726, -73.741148 40.60546, -73.740571 40.60488, -73.740291 40.604597999999996, -73.73922499999999 40.604141999999996, -73.738151 40.602709999999995, -73.737997 40.601600999999995, -73.738295 40.597991, -73.73830099999999 40.597795999999995, -73.73839199999999 40.597054, -73.73832999999999 40.596827999999995, -73.738097 40.595982, -73.73814399999999 40.594651, -73.73814999999999 40.594539, -73.73814999999999 40.594476, -73.73814999999999 40.594229, -73.73749099999999 40.593579999999996, -73.737414 40.593424999999996, -73.73725999999999 40.593117, -73.737185 40.592965, -73.737223 40.592963999999995, -73.73839 40.592939, -73.738468 40.592937, -73.740019 40.592906, -73.74162799999999 40.592872, -73.743237 40.592839, -73.74338 40.592847, -73.74360399999999 40.592859, -73.74382899999999 40.592870999999995, -73.744469 40.592904, -73.747749 40.591502999999996, -73.750978 40.589048999999996, -73.752121 40.588181999999996, -73.752371 40.587965, -73.755183 40.585649, -73.75550199999999 40.585387, -73.755567 40.583186, -73.75556999999999 40.583093999999996, -73.755701 40.578688, -73.756909 40.567651999999995, -73.75804699999999 40.557268, -73.758256 40.555364, -73.76223399999999 40.550202999999996, -73.764932 40.544402, -73.76727199999999 40.538111, -73.76763 40.537152, -73.768739 40.533873, -73.76878099999999 40.533747, -73.772964 40.533370999999995, -73.77698099999999 40.533012, -73.783969 40.532387, -73.792855 40.530381999999996, -73.804242 40.527815, -73.818919 40.524505, -73.82615799999999 40.522874, -73.829875 40.521464, -73.837816 40.518453, -73.854843 40.512, -73.860609 40.508386, -73.870029 40.502486, -73.876778 40.501127, -73.881839 40.495689999999996, -73.882272 40.49521, -73.886652 40.489793999999996, -73.943747 40.522014, -73.949912 40.52554, -73.95033699999999 40.525464, -73.954988 40.524634, -73.957274 40.524226, -73.99315899999999 40.517911999999995, -74.042112 40.509299, -74.05759499999999 40.506529, -74.057873 40.506476, -74.071052 40.503910999999995, -74.07817899999999 40.502505, -74.08289599999999 40.501666, -74.082904 40.501664999999996, -74.091492 40.500136999999995, -74.09167 40.500105, -74.092298 40.499989, -74.094483 40.499601, -74.098576 40.498903999999996, -74.107576 40.497417, -74.124549 40.494620999999995, -74.131132 40.493533, -74.13715599999999 40.492537999999996, -74.143917 40.491394, -74.14993799999999 40.490372, -74.152069 40.490017, -74.160393 40.48869, -74.162634 40.48829, -74.163861 40.488071, -74.20034199999999 40.482018, -74.200395 40.482009, -74.206451 40.481015, -74.217041 40.479223999999995, -74.22815299999999 40.477399, -74.237935 40.481241, -74.240691 40.482341999999996, -74.243652 40.483526, -74.248261 40.485367, -74.24858499999999 40.485496999999995, -74.249589 40.485898, -74.249743 40.48596, -74.24989699999999 40.486021, -74.249934 40.486035, -74.252646 40.48712, -74.253159 40.487325, -74.25331299999999 40.487386, -74.254289 40.489005999999996, -74.25653 40.492965, -74.25671899999999 40.493299, -74.257317 40.494349, -74.259028 40.497107, -74.25909 40.497206999999996, -74.259089 40.499561, -74.259089 40.499871999999996, -74.25908799999999 40.500112, -74.25908799999999 40.500133999999996, -74.259089 40.500465, -74.25909 40.500983, -74.259089 40.502278, -74.259089 40.50289, -74.25857599999999 40.506112, -74.258556 40.506232, -74.258473 40.506752999999996, -74.25837 40.507397, -74.258291 40.507905, -74.258262 40.507964, -74.257192 40.510244, -74.256984 40.510687999999995, -74.25634 40.512066999999995, -74.255924 40.512958, -74.255488 40.513889999999996, -74.255149 40.514618, -74.25480999999999 40.515344, -74.254417 40.515719, -74.253038 40.516583, -74.25166 40.517448, -74.24606899999999 40.520952, -74.24607 40.520972, -74.246084 40.521293, -74.24609699999999 40.521614, -74.246408 40.524356999999995, -74.246444 40.524673, -74.248787 40.533032999999996, -74.250205 40.539629, -74.250609 40.541851, -74.249274 40.544922, -74.249211 40.545063999999996, -74.247415 40.5492, -74.239211 40.553764, -74.233052 40.557609, -74.232788 40.557773, -74.232525 40.557938, -74.232152 40.558158, -74.232134 40.55817, -74.231926 40.558310999999996, -74.23169299999999 40.558457, -74.230992 40.558395999999995, -74.230312 40.558336, -74.230291 40.558333999999995, -74.229685 40.558281, -74.22908 40.558228, -74.22824 40.558130999999996, -74.2274 40.558034, -74.225956 40.557868, -74.224513 40.557701, -74.218398 40.556996, -74.216839 40.558617999999996, -74.216816 40.558642, -74.2167 40.558763, -74.216583 40.558884, -74.216028 40.559461, -74.215473 40.560038, -74.215278 40.560241, -74.21221 40.568177, -74.21148099999999 40.570062, -74.210779 40.571877, -74.210752 40.571948, -74.20985999999999 40.574256, -74.208968 40.576563, -74.20829599999999 40.579052, -74.20826699999999 40.579193, -74.208257 40.579242, -74.208237 40.579333999999996, -74.20751899999999 40.582741, -74.206802 40.586148, -74.20629799999999 40.588542, -74.203688 40.592690999999995, -74.19951999999999 40.597539, -74.199519 40.597564999999996, -74.199488 40.598287, -74.19945799999999 40.599008999999995, -74.199421 40.59988, -74.19940799999999 40.600201, -74.203813 40.605961, -74.20375899999999 40.606604, -74.20312799999999 40.614109, -74.202541 40.616175, -74.202434 40.61655, -74.201864 40.618556999999996, -74.20316199999999 40.622485999999995, -74.20373699999999 40.624227, -74.203485 40.625057999999996, -74.202441 40.628521, -74.202247 40.630902999999996, -74.20152999999999 40.6316, -74.20100000000001 40.632115, -74.200469 40.63263, -74.197428 40.63543, -74.19709399999999 40.635737, -74.19699 40.635832, -74.196505 40.636496, -74.19601999999999 40.637161, -74.195842 40.637404, -74.195711 40.637583, -74.195706 40.637589999999996, -74.195664 40.637648, -74.19564299999999 40.637667, -74.19348099999999 40.639669999999995, -74.191298 40.641691, -74.190489 40.64244, -74.18968 40.643187999999995, -74.189216 40.643561, -74.188754 40.643934, -74.188549 40.6441, -74.188344 40.644264, -74.187797 40.644604, -74.187754 40.644631, -74.186776 40.64524, -74.185636 40.645995, -74.18139 40.646474999999995, -74.180548 40.646381999999996, -74.179071 40.646215, -74.177595 40.646049, -74.170611 40.645289, -74.16170699999999 40.644321999999995, -74.161563 40.644306, -74.16149 40.644298, -74.161374 40.644284999999996, -74.15953499999999 40.644054, -74.158255 40.643895, -74.157977 40.64386, -74.157699 40.643825, -74.156432 40.643667, -74.153509 40.64333, -74.14938099999999 40.642855, -74.143255 40.642148999999996, -74.142077 40.642246, -74.141899 40.642275999999995, -74.135904 40.643332, -74.135817 40.643347999999996, -74.133912 40.643684, -74.1318 40.643755, -74.130022 40.643815, -74.128151 40.643902, -74.125569 40.644023, -74.124107 40.644451, -74.12383 40.644532, -74.123553 40.644613, -74.122114 40.645033999999995, -74.12067499999999 40.645455999999996, -74.116509 40.646451, -74.112343 40.647445999999995, -74.109976 40.648011, -74.10631599999999 40.648061999999996, -74.10504 40.64808, -74.100247 40.648148, -74.094178 40.648233, -74.093746 40.648239, -74.091253 40.649443999999995, -74.090582 40.64977, -74.087418 40.6513, -74.086806 40.651596, -74.077261 40.651731, -74.074415 40.651771, -74.07157 40.651812, -74.055739 40.651759999999996, -74.054622 40.653406, -74.054547 40.65354, -74.05435 40.653856, -74.054332 40.653875, -74.05430199999999 40.653907, -74.053484 40.655203, -74.053229 40.655657, -74.053016 40.656031999999996, -74.052802 40.656408, -74.052292 40.657303999999996, -74.051783 40.6582, -74.05136999999999 40.658926, -74.05081799999999 40.659848, -74.050495 40.660385, -74.050485 40.660402, -74.05015 40.660834, -74.049786 40.661303, -74.049594 40.661622, -74.048937 40.662701999999996, -74.04822 40.663905, -74.047663 40.664832, -74.045951 40.66768, -74.044669 40.669813, -74.04350699999999 40.671745, -74.04275899999999 40.672988, -74.035944 40.684326999999996, -74.03586299999999 40.684461, -74.035844 40.684492, -74.034444 40.686827, -74.03349399999999 40.688348, -74.02628399999999 40.699902, -74.02597 40.701623999999995, -74.0254 40.704739, -74.024945 40.707232999999995, -74.024543 40.709436, -74.02388599999999 40.713032, -74.02373 40.713888, -74.023386 40.715773999999996, -74.02255099999999 40.720349999999996, -74.022511 40.720573, -74.02196099999999 40.723586, -74.021588 40.725088, -74.02156099999999 40.725218, -74.02151599999999 40.725448, -74.02111699999999 40.727416999999996, -74.021104 40.727467999999995, -74.020775 40.728811, -74.020724 40.729016, -74.020405 40.730320999999996, -74.019809 40.732752, -74.01935999999999 40.734587999999995, -74.018926 40.736357, -74.01825099999999 40.739117, -74.01807 40.739852, -74.017867 40.740677999999996, -74.017138 40.743652999999995, -74.017022 40.744127, -74.016784 40.745101, -74.015677 40.749347, -74.01548 40.750101, -74.013784 40.756600999999996, -74.01337699999999 40.757219, -74.0124 40.758706, -74.011493 40.760085, -74.01112599999999 40.760645, -74.009852 40.762585, -74.009799 40.762665999999996, -74.00952 40.76309, -74.00918399999999 40.763601, -74.00827 40.764846999999996, -74.005854 40.768148, -74.005083 40.769200999999995, -74.004328 40.77024, -74.00138299999999 40.774301, -74.001327 40.774384, -74.000219 40.776047, -73.999583 40.777001, -73.999583 40.777158, -73.998575 40.778597, -73.997768 40.77975, -73.997383 40.780301, -73.995811 40.782396, -73.995705 40.782534999999996, -73.994765 40.783789, -73.993842 40.785022, -73.99288299999999 40.786301, -73.99198299999999 40.787600999999995, -73.991618 40.788109999999996, -73.99130099999999 40.78855, -73.98995699999999 40.790424, -73.988123 40.792981, -73.986256 40.795584999999996, -73.984883 40.7975, -73.984923 40.797517, -73.984889 40.797562, -73.98440699999999 40.798198, -73.982512 40.800705, -73.98058 40.803261, -73.979886 40.804181, -73.97876099999999 40.805667, -73.977021 40.807969, -73.974882 40.8108, -73.97157299999999 40.815616999999996, -73.97113 40.81626, -73.970621 40.817001999999995, -73.970112 40.817743, -73.968081 40.820701, -73.96798299999999 40.820826, -73.96728999999999 40.821704, -73.966596 40.822581, -73.966151 40.823144, -73.965986 40.823352, -73.965706 40.823706, -73.965138 40.824425, -73.965092 40.824483, -73.963657 40.826298, -73.963182 40.8269, -73.962349 40.828807999999995, -73.96145 40.830869, -73.961198 40.831447, -73.959915 40.834384, -73.958608 40.837381, -73.958382 40.837900000000005, -73.957621 40.839647, -73.955534 40.844435999999995, -73.953982 40.848, -73.953482 40.849000000000004, -73.95217199999999 40.851368, -73.952044 40.851599, -73.95175499999999 40.852121, -73.948385 40.858471, -73.94776499999999 40.85955, -73.945914 40.862545, -73.94529899999999 40.863541999999995, -73.94388599999999 40.865854, -73.943207 40.866974, -73.943111 40.867132, -73.942864 40.867539, -73.941856 40.869135, -73.94112799999999 40.870374, -73.94020499999999 40.871832999999995, -73.939562 40.872912, -73.93900599999999 40.873815, -73.93855599999999 40.874503, -73.938385 40.874775, -73.938171 40.875116, -73.933808 40.882214, -73.933652 40.882463, -73.93172899999999 40.885577999999995, -73.92982099999999 40.888681999999996, -73.92945499999999 40.889621999999996, -73.929428 40.889692, -73.929187 40.890308, -73.928294 40.892562, -73.92724199999999 40.895198, -73.92711899999999 40.895496, -73.926549 40.896879, -73.925922 40.898477, -73.925665 40.899150999999996, -73.924953 40.901018, -73.924235 40.902736, -73.923842 40.903675, -73.923307 40.905062, -73.922467 40.907236, -73.92096699999999 40.911012, -73.920087 40.913128, -73.919898 40.913604, -73.919097 40.914806, -73.918795 40.915971, -73.918494 40.917134, -73.91840499999999 40.917477, -73.918352 40.917488, -73.918128 40.917532, -73.91790499999999 40.917577, -73.910808 40.915372, -73.910516 40.915282, -73.910279 40.915186999999996, -73.910006 40.915076, -73.90949599999999 40.914930999999996, -73.909471 40.914924, -73.90884 40.914753999999995, -73.90881399999999 40.914747, -73.908328 40.914615999999995, -73.90832 40.914614, -73.90830199999999 40.914609, -73.905947 40.913948, -73.905911 40.913938, -73.90419399999999 40.91346, -73.903806 40.913353, -73.90245399999999 40.912979, -73.902106 40.912879, -73.900697 40.912380999999996, -73.89997 40.912132, -73.899789 40.912071999999995, -73.89950499999999 40.911978, -73.898682 40.911871, -73.89811999999999 40.911798, -73.897424 40.911693, -73.897368 40.911676, -73.89735999999999 40.911671999999996, -73.89725299999999 40.911654999999996, -73.89663399999999 40.911324, -73.896543 40.911293, -73.892799 40.910058, -73.89220499999999 40.909878, -73.891928 40.909808999999996, -73.89180499999999 40.909777999999996, -73.88839399999999 40.908719999999995, -73.887984 40.908592999999996, -73.886237 40.908052, -73.88616499999999 40.90803, -73.886124 40.908015999999996, -73.88601 40.907979, -73.885401 40.907976999999995, -73.884832 40.907723, -73.884726 40.907685, -73.88424599999999 40.907512, -73.88412699999999 40.907503, -73.884106 40.907500999999996, -73.88405399999999 40.907497, -73.882993 40.907423, -73.882829 40.907382, -73.88182499999999 40.907134, -73.88144299999999 40.907004, -73.880929 40.90683, -73.880637 40.906745, -73.880111 40.906591, -73.879531 40.906441, -73.879239 40.906365, -73.878827 40.906188, -73.87835 40.905983, -73.87822 40.905983, -73.87818899999999 40.905983, -73.878012 40.905964999999995, -73.877855 40.905922, -73.877741 40.905888, -73.877628 40.905854, -73.876588 40.905539, -73.87645499999999 40.905497, -73.876229 40.905429999999996, -73.875599 40.905243999999996, -73.875559 40.905232, -73.874797 40.90501, -73.874623 40.904959999999996, -73.874087 40.904807, -73.873949 40.904767, -73.872913 40.904467, -73.87273499999999 40.904415, -73.87093999999999 40.903887, -73.87073099999999 40.903825999999995, -73.869046 40.903332999999996, -73.867876 40.902983, -73.866952 40.902474999999995, -73.865635 40.902086, -73.865268 40.901962, -73.865256 40.901958, -73.86466899999999 40.901793, -73.862878 40.901529, -73.86286 40.901525, -73.86264299999999 40.901474, -73.862557 40.901427, -73.86240099999999 40.901340999999995, -73.86204099999999 40.901202999999995, -73.86158999999999 40.901050999999995, -73.860956 40.900846, -73.86077499999999 40.900787, -73.860321 40.900638, -73.86025699999999 40.900616, -73.86010399999999 40.900577999999996, -73.860006 40.900565, -73.859949 40.900558, -73.859808 40.90054, -73.85959 40.900513, -73.85931 40.900479, -73.8593 40.900493999999995, -73.85920399999999 40.900878, -73.85921499999999 40.900906, -73.859308 40.901137999999996, -73.859404 40.901378, -73.859037 40.901469999999996, -73.859003 40.901478, -73.85901799999999 40.901492999999995, -73.859303 40.901778, -73.859392 40.901894999999996, -73.85960399999999 40.902178, -73.85911399999999 40.902471999999996, -73.859104 40.902477999999995, -73.859014 40.902432999999995, -73.858469 40.902159999999995, -73.858302 40.902077, -73.858221 40.902335, -73.8582 40.902378999999996, -73.858042 40.902443999999996, -73.85792 40.902494, -73.85782499999999 40.902533, -73.857805 40.902539999999995, -73.85770699999999 40.902572, -73.857199 40.902878, -73.857 40.903579, -73.85700299999999 40.903735999999995, -73.857004 40.903819999999996, -73.857004 40.903861, -73.857004 40.904041, -73.857004 40.904168999999996, -73.857004 40.904378, -73.857079 40.904416, -73.857232 40.904492999999995, -73.857404 40.904579, -73.857449 40.904601, -73.857587 40.904669, -73.857449 40.904837, -73.857321 40.905017, -73.857136 40.904984999999996, -73.85710399999999 40.904979, -73.856956 40.904953, -73.856697 40.90491, -73.856434 40.905027, -73.856394 40.905045, -73.856388 40.905048, -73.85631 40.905083, -73.856151 40.905153, -73.856118 40.905167999999996, -73.85612499999999 40.905192, -73.856156 40.905297999999995, -73.856186 40.905401999999995, -73.856279 40.905727999999996, -73.856326 40.905801, -73.856325 40.905966, -73.856324 40.906166, -73.85622699999999 40.906119, -73.85615299999999 40.906082, -73.85610799999999 40.90606, -73.85607399999999 40.90606, -73.855997 40.90606, -73.85574 40.90606, -73.855687 40.90606, -73.85557399999999 40.906121999999996, -73.85553399999999 40.906144, -73.855527 40.906147999999995, -73.85531499999999 40.906262999999996, -73.855104 40.906378, -73.854704 40.906577999999996, -73.854128 40.906675, -73.85410399999999 40.906679, -73.854007 40.906842, -73.853802 40.907179, -73.853804 40.907681, -73.854295 40.907916, -73.854393 40.907962999999995, -73.854496 40.908017, -73.85476799999999 40.908159, -73.854796 40.908173, -73.85488099999999 40.908217, -73.854342 40.908974, -73.85423399999999 40.909009999999995, -73.85403699999999 40.909231, -73.85399699999999 40.909276, -73.853713 40.909447, -73.852935 40.909918999999995, -73.8529 40.909915999999996, -73.852678 40.909898999999996, -73.852184 40.909515, -73.851379 40.910044, -73.851123 40.910008999999995, -73.851484 40.909591999999996, -73.851812 40.909228999999996, -73.851872 40.909158999999995, -73.852046 40.908958999999996, -73.85207799999999 40.908887, -73.852369 40.908879999999996, -73.852808 40.908327, -73.852813 40.908321, -73.85306899999999 40.908021, -73.853528 40.907464999999995, -73.85279 40.907073, -73.85260099999999 40.906977, -73.852564 40.906968, -73.852204 40.906878, -73.851506 40.906645, -73.851304 40.906577999999996, -73.851057 40.906458, -73.851019 40.906501999999996, -73.850661 40.906925, -73.850518 40.907123999999996, -73.85045199999999 40.907182999999996, -73.85042299999999 40.907207, -73.850331 40.907281999999995, -73.850225 40.907368, -73.849126 40.906923, -73.848803 40.906791999999996, -73.848732 40.906763, -73.848683 40.906743, -73.847071 40.906172999999995, -73.84679899999999 40.906078, -73.846256 40.905842, -73.846104 40.905777, -73.84540299999999 40.905604, -73.84532 40.905581999999995, -73.844847 40.90531, -73.844728 40.904731999999996, -73.844713 40.904624999999996, -73.844702 40.904177, -73.84438899999999 40.904095999999996, -73.844301 40.904078, -73.84336499999999 40.90408, -73.843305 40.90408, -73.84232 40.903988999999996, -73.842308 40.903988, -73.842221 40.903985999999996, -73.841318 40.903987, -73.841296 40.903926, -73.841293 40.903918, -73.841291 40.903912999999996, -73.841281 40.903886, -73.84113599999999 40.903487, -73.841062 40.903214, -73.841048 40.903161999999995, -73.841017 40.902978999999995, -73.840999 40.902812, -73.840958 40.902516, -73.840873 40.901979, -73.84083199999999 40.901818999999996, -73.84078699999999 40.901693, -73.840729 40.901567, -73.84065 40.901413999999995, -73.84056199999999 40.901284, -73.840445 40.901123999999996, -73.84021 40.900804, -73.84018999999999 40.900777, -73.84018499999999 40.90077, -73.84017899999999 40.900762, -73.840172 40.900753, -73.840159 40.900735, -73.840085 40.900634, -73.840049 40.900585, -73.840045 40.900579, -73.840036 40.900566999999995, -73.83936299999999 40.899713, -73.839287 40.899594, -73.839221 40.899474999999995, -73.839185 40.89936, -73.83915499999999 40.899226, -73.839154 40.899198999999996, -73.83914899999999 40.899060999999996, -73.839208 40.898818999999996, -73.839241 40.898744, -73.839257 40.898707, -73.83939099999999 40.89841, -73.83950999999999 40.898184, -73.839649 40.897891, -73.83972 40.897694, -73.83972399999999 40.897633, -73.83971799999999 40.897511, -73.839696 40.897385, -73.839677 40.897323, -73.839655 40.897248999999995, -73.839615 40.89714, -73.839411 40.896693, -73.838985 40.895602, -73.838407 40.894061, -73.837368 40.893820999999996, -73.83733699999999 40.893814, -73.836282 40.893530999999996, -73.835605 40.893315, -73.835174 40.89317, -73.833595 40.892706, -73.83271599999999 40.892443, -73.8327 40.892438, -73.832503 40.892376999999996, -73.831863 40.892219, -73.831856 40.892216999999995, -73.83170299999999 40.892178, -73.830972 40.891935, -73.830818 40.891878999999996, -73.83008699999999 40.8917, -73.830022 40.891686, -73.828716 40.891273999999996, -73.828125 40.891051, -73.82794299999999 40.890927999999995, -73.827269 40.890797, -73.827224 40.890785, -73.825256 40.890248, -73.82524099999999 40.890243999999996, -73.825002 40.890178, -73.82440299999999 40.889978, -73.82402499999999 40.889978, -73.82400899999999 40.889978, -73.824047 40.889866, -73.82403599999999 40.889823, -73.824017 40.88975, -73.82396299999999 40.889762999999995, -73.823781 40.889809, -73.823607 40.889852999999995, -73.823557 40.889865, -73.823555 40.889869999999995, -73.823573 40.889882, -73.82359799999999 40.889956, -73.82368 40.890029999999996, -73.823689 40.890076, -73.82367099999999 40.890136999999996, -73.823661 40.89017, -73.82365 40.890338, -73.823634 40.890391, -73.823617 40.890412999999995, -73.823576 40.890426, -73.823527 40.890429999999995, -73.823373 40.890415999999995, -73.823303 40.890420999999996, -73.823172 40.890544999999996, -73.82312 40.890648, -73.82311299999999 40.890777, -73.823132 40.890871, -73.823205 40.890918, -73.823256 40.890961, -73.823302 40.890989, -73.82328199999999 40.891082, -73.823244 40.891199, -73.823003 40.891078, -73.822959 40.891056, -73.821703 40.89073, -73.820994 40.890543, -73.81971899999999 40.890206, -73.819558 40.890163, -73.8195 40.890147, -73.819419 40.890125, -73.818929 40.889993, -73.818732 40.889939999999996, -73.81850299999999 40.889877999999996, -73.81761399999999 40.889679, -73.817596 40.889675, -73.816732 40.889503, -73.816611 40.889479, -73.81648299999999 40.88943, -73.816206 40.889316, -73.816104 40.889275999999995, -73.815603 40.889178, -73.81532899999999 40.889066, -73.815165 40.888999, -73.81504799999999 40.888951, -73.813761 40.888721, -73.813659 40.888706, -73.81363999999999 40.888701999999995, -73.813617 40.888695999999996, -73.812645 40.888436999999996, -73.812429 40.88838, -73.811266 40.888093999999995, -73.811101 40.888044, -73.811065 40.888033, -73.810953 40.887997999999996, -73.810908 40.887983999999996, -73.8109 40.887982, -73.80994199999999 40.88769, -73.809923 40.887684, -73.809457 40.887603999999996, -73.80872 40.887481, -73.808351 40.887361, -73.80757299999999 40.887102, -73.807564 40.887099, -73.806395 40.886801, -73.80572599999999 40.886662, -73.805402 40.886596, -73.805343 40.886584, -73.805311 40.886579999999995, -73.805302 40.886579, -73.804789 40.886505, -73.80476999999999 40.886500000000005, -73.804604 40.886455999999995, -73.80446599999999 40.88642, -73.804191 40.886348, -73.80300199999999 40.886033999999995, -73.802945 40.886019, -73.801896 40.885707, -73.801617 40.885632, -73.799289 40.885007, -73.798295 40.884738999999996, -73.797348 40.88449, -73.797302 40.884478, -73.797102 40.884478, -73.796306 40.884297, -73.79628199999999 40.884291, -73.79486299999999 40.883914, -73.794311 40.883781, -73.794048 40.883717999999995, -73.792942 40.883410999999995, -73.785797 40.8816, -73.78370199999999 40.881077999999995, -73.78355499999999 40.881042, -73.783519 40.881032999999995, -73.783408 40.881006, -73.782838 40.880868, -73.78226699999999 40.880728999999995, -73.781202 40.880478, -73.760988 40.875178, -73.749483 40.872101, -73.74806 40.871721, -73.753732 40.856556, -73.753787 40.856409, -73.757801 40.845679, -73.757967 40.845535999999996, -73.76164 40.842372, -73.762174 40.841910999999996, -73.773429 40.832214, -73.77452 40.831272999999996, -73.77497699999999 40.830878999999996, -73.780193 40.8264, -73.779416 40.812242, -73.774715 40.807075999999995, -73.77025499999999 40.802625, -73.764765 40.796844, -73.756187 40.788703, -73.750817 40.782886999999995, -73.750655 40.782711, -73.750304 40.782531999999996, -73.749575 40.781898, -73.74942399999999 40.781755, -73.748007 40.780412, -73.746831 40.778994999999995, -73.746439 40.778811999999995, -73.745898 40.778904, -73.745898 40.779064999999996, -73.74686299999999 40.780001999999996, -73.746893 40.780345, -73.74676 40.780381999999996, -73.74636799999999 40.78012, -73.745436 40.779497, -73.74421 40.778704999999995, -73.743421 40.778224, -73.741535 40.777111, -73.74076 40.776695, -73.740366 40.77639, -73.739646 40.776084, -73.73945599999999 40.775952, -73.739361 40.775867999999996, -73.739143 40.775673999999995, -73.73896599999999 40.775518, -73.73875199999999 40.775497, -73.737853 40.774879, -73.736873 40.774328, -73.73376 40.772469, -73.733049 40.77196, -73.73201499999999 40.771426, -73.73113099999999 40.77086, -73.730288 40.770385, -73.72959 40.769985, -73.72871099999999 40.769467999999996, -73.727888 40.768898, -73.72661 40.76813, -73.725608 40.767539, -73.72355999999999 40.766129, -73.72305899999999 40.766144, -73.723036 40.766118999999996, -73.722484 40.765527, -73.72240099999999 40.765487, -73.720942 40.764793999999995, -73.720653 40.764477, -73.720073 40.764089, -73.716459 40.761705, -73.714438 40.76045, -73.713432 40.759761, -73.713034 40.759566, -73.712898 40.75949, -73.712761 40.759415, -73.712605 40.759328, -73.71244899999999 40.759242, -73.711548 40.758649, -73.71134099999999 40.758513, -73.710858 40.758195, -73.710606 40.75803, -73.710112 40.757708, -73.709501 40.75731, -73.709374 40.757227, -73.707825 40.756215999999995, -73.707082 40.755718, -73.706338 40.75522, -73.706282 40.755182, -73.705879 40.754912999999995, -73.70542 40.754605999999995, -73.703625 40.753664, -73.703282 40.753505, -73.702938 40.753344999999996, -73.70283599999999 40.753298, -73.70273499999999 40.753251, -73.702178 40.752886, -73.70174399999999 40.75253, -73.70146799999999 40.751321, -73.701342 40.750766999999996, -73.701168 40.748864999999995, -73.700901 40.747129, -73.70087199999999 40.746866, -73.700768 40.745014, -73.700582 40.743184, -73.70029199999999 40.74105, -73.700277 40.73972, -73.700272 40.739242, -73.700319 40.739202999999996, -73.700356 40.739171999999996, -73.700655 40.738319, -73.701239 40.737427, -73.702004 40.736522, -73.70218899999999 40.73611, -73.702411 40.735777999999996, -73.70259 40.73551, -73.703315 40.734563, -73.70352199999999 40.734207999999995, -73.70394499999999 40.733526, -73.704599 40.732502, -73.704859 40.732015, -73.704869 40.731997, -73.704882 40.731981, -73.705269 40.731513, -73.705772 40.73073, -73.70648 40.729710999999995, -73.707129 40.728702, -73.707662 40.727830999999995, -73.708569 40.727636, -73.709019 40.727540999999995, -73.709396 40.727461, -73.709774 40.727381, -73.710336 40.727261999999996, -73.71050000000001 40.727227, -73.711322 40.72712, -73.711882 40.727047, -73.712407 40.726977999999995, -73.713323 40.726858, -73.71407599999999 40.72676, -73.714969 40.726647, -73.71588 40.726541999999995, -73.716684 40.726375, -73.718287 40.726040999999995, -73.72038599999999 40.725474999999996, -73.720902 40.725342, -73.721018 40.725311999999995, -73.72106699999999 40.725299, -73.721122 40.725285, -73.721193 40.725266999999995, -73.721786 40.725089, -73.722042 40.725013, -73.72260899999999 40.724869999999996, -73.722912 40.724793999999996, -73.723428 40.724663, -73.72399399999999 40.724509999999995, -73.724122 40.724475, -73.724284 40.724430999999996, -73.724447 40.724387, -73.72473099999999 40.724309999999996, -73.724834 40.724289999999996, -73.725132 40.724233, -73.725672 40.724038, -73.725923 40.723949, -73.72647599999999 40.723752999999995, -73.726816 40.723617, -73.727234 40.723448999999995, -73.727328 40.723411999999996, -73.727482 40.723351, -73.727971 40.723158999999995, -73.728162 40.723084, -73.728633 40.722882, -73.72891299999999 40.722761999999996, -73.729438 40.722536999999996)))"
    val geom = new WKTReader().read(wkt)
    val gridifier = new Gridifier(numXCells, numYCells)
    gridifier.gridify(geom, true)
  }
}

object Gridifier {
  def coverAtAllLevels(sizes: List[(Int, Int)], g: Geometry, includeGeometry: Boolean): List[Long] = {
    sizes.flatMap(size => {
      new Gridifier(size._1, size._2).gridify(g, false).map(_.cell.id)
    })
  }
}

class Gridifier(numXCells: Int, numYCells: Int) {
  assert(numXCells < 100000)
  assert(numYCells < 40000)

  val degreesPerXCell = (360.0 / numXCells)
  val degreesPerYCell = (180.0 / numYCells)

  case class GridCell(x: Int, y: Int) {
    def upperLeft = new Coordinate((x*degreesPerXCell)-180, (y*degreesPerYCell)-90)
    def bounds: Geometry = {
      val gsf = new GeometricShapeFactory();
      gsf.setBase(upperLeft)
      gsf.setNumPoints(4)
      gsf.setWidth(degreesPerXCell)
      gsf.setHeight(degreesPerYCell)
      gsf.createRectangle
    }
    def name = "%s,%s".format(x, y)
    val id: Long = y.toLong * 100000L + x.toLong
  }

  case class ClippedGridCell(cell: GridCell, full: Boolean, g: Option[Geometry] = None)

  def getXIndex(coord: Coordinate): Int = Math.min(((coord.x + 180) / degreesPerXCell).toInt, numXCells)
  def getYIndex(coord: Coordinate): Int = Math.min(((coord.y + 90) / degreesPerYCell).toInt, numYCells)
  def toIndex(coord: Coordinate): GridCell = GridCell(getXIndex(coord), getYIndex(coord))

  object Coords extends Enumeration {
      type Coords = Value
      val BottomLeft, BottomRight, TopRight, TopLeft = Value
  }

  // val debugWriter = new SimpleGeometryWriter()

  def gridify(g: Geometry, includeGeometry: Boolean): Seq[ClippedGridCell] = {
    //debugWriter.add(g, "geom")
    val env = g.getEnvelope
    assert(env.isRectangle)

    val minCell = toIndex(env.getCoordinates()(Coords.BottomLeft.id))
    val maxCell = toIndex(env.getCoordinates()(Coords.TopRight.id))

    for {
      x <- minCell.x.to(maxCell.x)
      y <- minCell.y.to(maxCell.y)
    } yield {
      //debugWriter.add(GridCell(x, y).bounds, "%s,%s".format(x, y))
      val cell = GridCell(x, y)
      if (includeGeometry) {
        if (g.contains(cell.bounds)) {
          ClippedGridCell(cell, true)
        } else {
          ClippedGridCell(cell, false, Some(cell.bounds.intersection(g)))
        }
      } else {
        ClippedGridCell(cell, false)
      }
      //debugWriter.add(intersection, "intersection")
    }
    //debugWriter.write("debug.shp")
  }
}
